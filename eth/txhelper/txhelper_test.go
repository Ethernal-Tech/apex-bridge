package ethtxhelper

import (
	"context"
	"encoding/hex"
	"math/big"
	"testing"
	"time"

	"github.com/Ethernal-Tech/apex-bridge/contractbinding"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/require"
)

const (
	mumbaiNodeUrl    = "https://polygon-mumbai-pokt.nodies.app"
	dummyMumbaiAccPk = "3761f6deeb2e0b2aa8b843e804d880afa6e5fecf1631f411e267641a72d0ca20"
)

var (
	scBytecode, _ = hex.DecodeString("608060405234801561001057600080fd5b50600436106100935760003560e01c806377968b341161006657806377968b34146100fb5780637b0f07611461012b5780638594d36d14610147578063af8c1b8314610165578063d52c54c41461018157610093565b80632096525514610098578063433ce666146100b657806355241077146100d55780637498aede146100f1575b600080fd5b6100a06101b1565b6040516100ad9190611949565b60405180910390f35b6100be6101ba565b6040516100cc9291906118f0565b60405180910390f35b6100ef60048036038101906100ea91906115f9565b6102dc565b005b6100f96102e6565b005b6101156004803603810190610110919061151a565b610312565b60405161012291906118d5565b60405180910390f35b610145600480360381019061014091906115b0565b610460565b005b61014f610980565b60405161015c91906118d5565b60405180910390f35b61017f600480360381019061017a9190611567565b610997565b005b61019b6004803603810190610196919061151a565b610a14565b6040516101a89190611927565b60405180910390f35b60008054905090565b60018060000180546101cb90611b12565b80601f01602080910402602001604051908101604052809291908181526020018280546101f790611b12565b80156102445780601f1061021957610100808354040283529160200191610244565b820191906000526020600020905b81548152906001019060200180831161022757829003601f168201915b50505050509080600101805461025990611b12565b80601f016020809104026020016040519081016040528092919081815260200182805461028590611b12565b80156102d25780601f106102a7576101008083540402835291602001916102d2565b820191906000526020600020905b8154815290600101906020018083116102b557829003601f168201915b5050505050905082565b8060008190555050565b600560039054906101000a900460ff1615600560036101000a81548160ff021916908315150217905550565b6000604051602001610323906118c0565b60405160208183030381529060405280519060200120838360405160200161034c929190611868565b60405160208183030381529060405280519060200120141561037f57600560009054906101000a900460ff16905061045a565b60405160200161038e906118ab565b6040516020818303038152906040528051906020012083836040516020016103b7929190611868565b6040516020818303038152906040528051906020012014156103ea57600560019054906101000a900460ff16905061045a565b6040516020016103f990611896565b604051602081830303815290604052805190602001208383604051602001610422929190611868565b60405160208183030381529060405280519060200120141561045557600560029054906101000a900460ff16905061045a565b600090505b92915050565b60405160200161046f906118c0565b604051602081830303815290604052805190602001208180602001906104959190611964565b6040516020016104a6929190611868565b6040516020818303038152906040528051906020012014156104de576000600560006101000a81548160ff0219169083151502179055505b6040516020016104ed906118ab565b604051602081830303815290604052805190602001208180602001906105139190611964565b604051602001610524929190611868565b60405160208183030381529060405280519060200120141561055c576000600560016101000a81548160ff0219169083151502179055505b60405160200161056b90611896565b604051602081830303815290604052805190602001208180602001906105919190611964565b6040516020016105a2929190611868565b6040516020818303038152906040528051906020012014156105da576000600560026101000a81548160ff0219169083151502179055505b60068180606001906105ec9190611964565b90918060018154018082558091505060019003906000526020600020016000909192909192909192909192509190610625929190611046565b5060078180608001906106389190611964565b90918060018154018082558091505060019003906000526020600020016000909192909192909192909192509190610671929190611046565b506003600680549050141561097d576106886110cc565b6040518060400160405280600481526020017f313333370000000000000000000000000000000000000000000000000000000081525081600001819052508180604001906106d69190611964565b8080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505081602001819052506006805480602002602001604051908101604052809291908181526020016000905b828210156107ef57838290600052602060002001805461076290611b12565b80601f016020809104026020016040519081016040528092919081815260200182805461078e90611b12565b80156107db5780601f106107b0576101008083540402835291602001916107db565b820191906000526020600020905b8154815290600101906020018083116107be57829003601f168201915b505050505081526020019060010190610743565b5050505081604001819052506007805480602002602001604051908101604052809291908181526020016000905b828210156108c957838290600052602060002001805461083c90611b12565b80601f016020809104026020016040519081016040528092919081815260200182805461086890611b12565b80156108b55780601f1061088a576101008083540402835291602001916108b5565b820191906000526020600020905b81548152906001019060200180831161089857829003601f168201915b50505050508152602001906001019061081d565b505050508160600181905250600560039054906101000a900460ff1661097b576108f281610997565b6001600560036101000a81548160ff0219169083151502179055506006600061091b91906110f4565b6007600061092991906110f4565b6001600560006101000a81548160ff0219169083151502179055506001600560016101000a81548160ff0219169083151502179055506001600560026101000a81548160ff0219169083151502179055505b505b50565b6000600560039054906101000a900460ff16905090565b80600160008201518160000190805190602001906109b6929190611115565b5060208201518160010190805190602001906109d3929190611115565b5060408201518160020190805190602001906109f092919061119b565b506060820151816003019080519060200190610a0d92919061119b565b5090505050565b610a1c6110cc565b604051602001610a2b90611881565b604051602081830303815290604052805190602001208383604051602001610a54929190611868565b604051602081830303815290604052805190602001201415610d5a576001604051806080016040529081600082018054610a8d90611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610ab990611b12565b8015610b065780601f10610adb57610100808354040283529160200191610b06565b820191906000526020600020905b815481529060010190602001808311610ae957829003601f168201915b50505050508152602001600182018054610b1f90611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610b4b90611b12565b8015610b985780601f10610b6d57610100808354040283529160200191610b98565b820191906000526020600020905b815481529060010190602001808311610b7b57829003601f168201915b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610c72578382906000526020600020018054610be590611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610c1190611b12565b8015610c5e5780601f10610c3357610100808354040283529160200191610c5e565b820191906000526020600020905b815481529060010190602001808311610c4157829003601f168201915b505050505081526020019060010190610bc6565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015610d4b578382906000526020600020018054610cbe90611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610cea90611b12565b8015610d375780601f10610d0c57610100808354040283529160200191610d37565b820191906000526020600020905b815481529060010190602001808311610d1a57829003601f168201915b505050505081526020019060010190610c9f565b50505050815250509050611040565b6001604051806080016040529081600082018054610d7790611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610da390611b12565b8015610df05780601f10610dc557610100808354040283529160200191610df0565b820191906000526020600020905b815481529060010190602001808311610dd357829003601f168201915b50505050508152602001600182018054610e0990611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610e3590611b12565b8015610e825780601f10610e5757610100808354040283529160200191610e82565b820191906000526020600020905b815481529060010190602001808311610e6557829003601f168201915b5050505050815260200160028201805480602002602001604051908101604052809291908181526020016000905b82821015610f5c578382906000526020600020018054610ecf90611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610efb90611b12565b8015610f485780601f10610f1d57610100808354040283529160200191610f48565b820191906000526020600020905b815481529060010190602001808311610f2b57829003601f168201915b505050505081526020019060010190610eb0565b50505050815260200160038201805480602002602001604051908101604052809291908181526020016000905b82821015611035578382906000526020600020018054610fa890611b12565b80601f0160208091040260200160405190810160405280929190818152602001828054610fd490611b12565b80156110215780601f10610ff657610100808354040283529160200191611021565b820191906000526020600020905b81548152906001019060200180831161100457829003601f168201915b505050505081526020019060010190610f89565b505050508152505090505b92915050565b82805461105290611b12565b90600052602060002090601f01602090048101928261107457600085556110bb565b82601f1061108d57803560ff19168380011785556110bb565b828001600101855582156110bb579182015b828111156110ba57823582559160200191906001019061109f565b5b5090506110c891906111fb565b5090565b6040518060800160405280606081526020016060815260200160608152602001606081525090565b50805460008255906000526020600020908101906111129190611218565b50565b82805461112190611b12565b90600052602060002090601f016020900481019282611143576000855561118a565b82601f1061115c57805160ff191683800117855561118a565b8280016001018555821561118a579182015b8281111561118957825182559160200191906001019061116e565b5b50905061119791906111fb565b5090565b8280548282559060005260206000209081019282156111ea579160200282015b828111156111e95782518290805190602001906111d9929190611115565b50916020019190600101906111bb565b5b5090506111f79190611218565b5090565b5b808211156112145760008160009055506001016111fc565b5090565b5b80821115611238576000818161122f919061123c565b50600101611219565b5090565b50805461124890611b12565b6000825580601f1061125a5750611279565b601f01602090049060005260206000209081019061127891906111fb565b5b50565b600061128f61128a846119ec565b6119c7565b905080838252602082019050828560208602820111156112b2576112b1611bf6565b5b60005b8581101561130057813567ffffffffffffffff8111156112d8576112d7611bd8565b5b8086016112e589826113d0565b855260208501945060208401935050506001810190506112b5565b5050509392505050565b600061131d61131884611a18565b6119c7565b90508281526020810184848401111561133957611338611c00565b5b611344848285611ad0565b509392505050565b600082601f83011261136157611360611bd8565b5b813561137184826020860161127c565b91505092915050565b60008083601f8401126113905761138f611bd8565b5b8235905067ffffffffffffffff8111156113ad576113ac611bd3565b5b6020830191508360018202830111156113c9576113c8611bf6565b5b9250929050565b600082601f8301126113e5576113e4611bd8565b5b81356113f584826020860161130a565b91505092915050565b60006080828403121561141457611413611be7565b5b61141e60806119c7565b9050600082013567ffffffffffffffff81111561143e5761143d611bf1565b5b61144a848285016113d0565b600083015250602082013567ffffffffffffffff81111561146e5761146d611bf1565b5b61147a848285016113d0565b602083015250604082013567ffffffffffffffff81111561149e5761149d611bf1565b5b6114aa8482850161134c565b604083015250606082013567ffffffffffffffff8111156114ce576114cd611bf1565b5b6114da8482850161134c565b60608301525092915050565b600060e082840312156114fc576114fb611be2565b5b81905092915050565b60008135905061151481611cc4565b92915050565b6000806020838503121561153157611530611c0a565b5b600083013567ffffffffffffffff81111561154f5761154e611c05565b5b61155b8582860161137a565b92509250509250929050565b60006020828403121561157d5761157c611c0a565b5b600082013567ffffffffffffffff81111561159b5761159a611c05565b5b6115a7848285016113fe565b91505092915050565b6000602082840312156115c6576115c5611c0a565b5b600082013567ffffffffffffffff8111156115e4576115e3611c05565b5b6115f0848285016114e6565b91505092915050565b60006020828403121561160f5761160e611c0a565b5b600061161d84828501611505565b91505092915050565b600061163283836116e3565b905092915050565b600061164582611a59565b61164f8185611a7c565b93508360208202850161166185611a49565b8060005b8581101561169d578484038952815161167e8582611626565b945061168983611a6f565b925060208a01995050600181019050611665565b50829750879550505050505092915050565b6116b881611aba565b82525050565b60006116ca8385611aaf565b93506116d7838584611ad0565b82840190509392505050565b60006116ee82611a64565b6116f88185611a8d565b9350611708818560208601611adf565b61171181611c0f565b840191505092915050565b600061172782611a64565b6117318185611a9e565b9350611741818560208601611adf565b61174a81611c0f565b840191505092915050565b6000611762600583611aaf565b915061176d82611c20565b600582019050919050565b6000611785600683611aaf565b915061179082611c49565b600682019050919050565b60006117a8600683611aaf565b91506117b382611c72565b600682019050919050565b60006117cb600683611aaf565b91506117d682611c9b565b600682019050919050565b600060808301600083015184820360008601526117fe82826116e3565b9150506020830151848203602086015261181882826116e3565b91505060408301518482036040860152611832828261163a565b9150506060830151848203606086015261184c828261163a565b9150508091505092915050565b61186281611ac6565b82525050565b60006118758284866116be565b91508190509392505050565b600061188c82611755565b9150819050919050565b60006118a182611778565b9150819050919050565b60006118b68261179b565b9150819050919050565b60006118cb826117be565b9150819050919050565b60006020820190506118ea60008301846116af565b92915050565b6000604082019050818103600083015261190a818561171c565b9050818103602083015261191e818461171c565b90509392505050565b6000602082019050818103600083015261194181846117e1565b905092915050565b600060208201905061195e6000830184611859565b92915050565b6000808335600160200384360303811261198157611980611bec565b5b80840192508235915067ffffffffffffffff8211156119a3576119a2611bdd565b5b6020830192506001820236038313156119bf576119be611bfb565b5b509250929050565b60006119d16119e2565b90506119dd8282611b44565b919050565b6000604051905090565b600067ffffffffffffffff821115611a0757611a06611ba4565b5b602082029050602081019050919050565b600067ffffffffffffffff821115611a3357611a32611ba4565b5b611a3c82611c0f565b9050602081019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b60008115159050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015611afd578082015181840152602081019050611ae2565b83811115611b0c576000848401525b50505050565b60006002820490506001821680611b2a57607f821691505b60208210811415611b3e57611b3d611b75565b5b50919050565b611b4d82611c0f565b810181811067ffffffffffffffff82111715611b6c57611b6b611ba4565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f7072696d65000000000000000000000000000000000000000000000000000000600082015250565b7f7072696d65330000000000000000000000000000000000000000000000000000600082015250565b7f7072696d65320000000000000000000000000000000000000000000000000000600082015250565b7f7072696d65310000000000000000000000000000000000000000000000000000600082015250565b611ccd81611ac6565b8114611cd857600080fd5b5056fea2646970667358221220ee61c807c25abdc48c169a68ab59bc3a35d0d8f836cf47dac17842b0a8c5fc8364736f6c63430008070033")
)

func TestTxHelper(t *testing.T) {
	scAddress := "0xA4B44930686aC7179FC63688749EC60e0C4A96C3"

	wallet, err := NewEthTxWallet(dummyMumbaiAccPk)
	require.NoError(t, err)

	txHelper, err := NewEThTxHelper(WithNodeUrl(mumbaiNodeUrl))
	require.NoError(t, err)

	ctx, cancelCtx := context.WithTimeout(context.Background(), time.Second*60)
	defer cancelCtx()

	t.Run("deploy smart contract", func(t *testing.T) {
		abiData, err := contractbinding.TestContractMetaData.GetAbi()
		require.NoError(t, err)

		nonce, err := txHelper.GetNonce(ctx, wallet.GetAddressHex(), false)
		require.NoError(t, err)

		addr, hash, err := txHelper.Deploy(ctx, new(big.Int).SetUint64(nonce),
			uint64(300000), false, *abiData, scBytecode, wallet)
		require.NoError(t, err)
		require.NotEqual(t, common.Address{}, addr)

		receipt, err := txHelper.WaitForReceipt(ctx, hash, true)
		require.NoError(t, err)
		require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)
		require.Equal(t, common.HexToAddress(addr), receipt.ContractAddress)

		scAddress = addr
	})

	t.Run("sending smart contract transaction and query smart contract", func(t *testing.T) {
		valueToSet := uint64(time.Now().UTC().UnixNano())

		contract, err := contractbinding.NewTestContract(common.HexToAddress(scAddress), txHelper.GetClient())
		require.NoError(t, err)

		res, err := contract.GetValue(&bind.CallOpts{
			Context: ctx,
			From:    wallet.GetAddress(),
		})
		require.NoError(t, err)
		require.False(t, new(big.Int).SetUint64(valueToSet).Cmp(res) == 0)

		// first call is just for creating tx
		tx, err := txHelper.SendTx(ctx, wallet, bind.TransactOpts{}, true, func(txOpts *bind.TransactOpts) (*types.Transaction, error) {
			return contract.SetValue(txOpts, new(big.Int).SetUint64(valueToSet))
		})
		require.NoError(t, err)

		receipt, err := txHelper.WaitForReceipt(ctx, tx.Hash().String(), true)
		require.NoError(t, err)
		require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

		// check value again
		res, err = contract.GetValue(&bind.CallOpts{
			Context: ctx,
			From:    wallet.GetAddress(),
		})
		require.NoError(t, err)
		require.True(t, new(big.Int).SetUint64(valueToSet).Cmp(res) == 0)
	})

	t.Run("send transfer transaction legacy", func(t *testing.T) {
		const (
			ethAddr  = "0xBa65B75FDA35561626A455b1aF806A7C58A57DdE"
			ethValue = uint64(2001)
		)

		client, ok := txHelper.GetClient().(*ethclient.Client)
		require.True(t, ok)

		chainID, err := client.ChainID(ctx)
		require.NoError(t, err)

		oldVal, err := client.BalanceAt(ctx, common.HexToAddress(ethAddr), nil)
		require.NoError(t, err)

		// first call is just for creating tx
		txOpts := bind.TransactOpts{
			Value:    new(big.Int).SetUint64(ethValue),
			GasLimit: 21000, // default value for transfer
		}

		err = txHelper.PopulateTxOpts(ctx, wallet.GetAddressHex(), false, &txOpts)
		require.NoError(t, err)

		tx := TxOpts2LegacyTx(ethAddr, []byte{}, &txOpts)

		signedTx, err := wallet.SignTx(chainID, tx)
		require.NoError(t, err)

		err = client.SendTransaction(ctx, signedTx)
		require.NoError(t, err)

		receipt, err := txHelper.WaitForReceipt(ctx, signedTx.Hash().String(), true)
		require.NoError(t, err)
		require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

		// check value again
		newVal, err := client.BalanceAt(ctx, common.HexToAddress(ethAddr), nil)
		require.NoError(t, err)

		desiredVal := new(big.Int).Add(new(big.Int).SetUint64(ethValue), oldVal)
		require.True(t, desiredVal.Cmp(newVal) == 0)
	})

	t.Run("send transfer transaction dynamicfee", func(t *testing.T) {
		const (
			ethAddr  = "0xBa65B75FDA35561626A455b1aF806A7C58A57DdE"
			ethValue = uint64(2001)
		)

		client, ok := txHelper.GetClient().(*ethclient.Client)
		require.True(t, ok)

		chainID, err := client.ChainID(ctx)
		require.NoError(t, err)

		oldVal, err := client.BalanceAt(ctx, common.HexToAddress(ethAddr), nil)
		require.NoError(t, err)

		// first call is just for creating tx
		txOpts := bind.TransactOpts{
			Value:    new(big.Int).SetUint64(ethValue),
			GasLimit: 21000, // default value for transfer
		}

		err = txHelper.PopulateTxOpts(ctx, wallet.GetAddressHex(), true, &txOpts)
		require.NoError(t, err)

		tx := TxOpts2DynamicFeeTx(ethAddr, chainID, []byte{}, &txOpts)

		signedTx, err := wallet.SignTx(chainID, tx)
		require.NoError(t, err)

		err = client.SendTransaction(ctx, signedTx)
		require.NoError(t, err)

		receipt, err := txHelper.WaitForReceipt(ctx, signedTx.Hash().String(), true)
		require.NoError(t, err)
		require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

		// check value again
		newVal, err := client.BalanceAt(ctx, common.HexToAddress(ethAddr), nil)
		require.NoError(t, err)

		desiredVal := new(big.Int).Add(new(big.Int).SetUint64(ethValue), oldVal)
		require.True(t, desiredVal.Cmp(newVal) == 0)
	})
}
